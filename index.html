<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>mission</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f4f4f4;
      padding: 30px;
      max-width: 1100px;
      margin: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      border-radius: 8px;
      overflow: hidden;
      margin-bottom: 40px;
      table-layout: fixed;
    }
    th, td {
      padding: 12px;
      border: 1px solid #ddd;
      text-align: center;
      width: calc(100% / 6);
      vertical-align: top;
    }
    th { background-color: #f0f0f0; }
    .checkbox-group {
      display: flex;
      justify-content: center;
      gap: 4px;
      flex-wrap: wrap;
    }
   .task-name {
  text-align: center;   /* 기존 left → center */
  font-weight: bold;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

    input.name-input {
      width: 90px;
      text-align: center;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 4px;
    }
    .note-input {
      width: 40px;
      padding: 4px;
      margin-top: 4px;
    }
    .counter-wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
    }
    .timer { font-size: 0.85em; color: #444; }
    .hint  { font-size: 0.75em; color: #777; }
    input[type="number"] { width: 60px; }
    .section-title {
      margin-top: 40px;
      font-size: 1.2em;
      font-weight: bold;
      color: #444;
    }
    .big-note {
      width: 95%;
      min-height: 90px;
      border: 1px solid #ccc;
      border-radius: 6px;
      padding: 8px;
      resize: vertical;
      box-sizing: border-box;
      font-family: inherit;
      font-size: 14px;
      line-height: 1.4;
    }
  </style>
</head>
<body>
  <div class="section-title">Day</div>
  <table>
    <thead>
      <tr>
        <th>목록</th>
        <th><input class="name-input" value="본캐" onchange="updateName(0, this.value)"></th>
        <th><input class="name-input" value="부캐1" onchange="updateName(1, this.value)"></th>
        <th><input class="name-input" value="부캐2" onchange="updateName(2, this.value)"></th>
        <th><input class="name-input" value="부캐3" onchange="updateName(3, this.value)"></th>
        <th><input class="name-input" value="부캐4" onchange="updateName(4, this.value)"></th>
      </tr>
    </thead>
    <tbody id="dayTaskTable"></tbody>
  </table>

  <div class="section-title">Weekly</div>
  <table>
    <thead>
      <tr>
        <th>투력</th>
        <th><input class="name-input" value="본캐" onchange="updateName(0, this.value)"></th>
        <th><input class="name-input" value="부캐1" onchange="updateName(1, this.value)"></th>
        <th><input class="name-input" value="부캐2" onchange="updateName(2, this.value)"></th>
        <th><input class="name-input" value="부캐3" onchange="updateName(3, this.value)"></th>
        <th><input class="name-input" value="부캐4" onchange="updateName(4, this.value)"></th>
      </tr>
    </thead>
    <tbody id="weeklyTaskTable"></tbody>
  </table>

  <script>
    const dayTasksRaw = " ●동전 / ●공물 / ○일일미션 / ●요일던전 / ○○결계 / ●●○구멍 / ●망령 ";
    const weeklyTasksRaw = "○필드보스 / ○어비스 / ○글라스기브넨 / ●서큐버스";

    const playerNames = ["본캐", "부캐1", "부캐2", "부캐3", "부캐4"];
    const dayTasks = dayTasksRaw.split("/").map(t => t.trim());
    const weeklyTasks = weeklyTasksRaw.split("/").map(t => t.trim());

    function parseTask(raw) {
      const m = raw.match(/^([●○]+)(.+)$/);
      if (!m) return null;
      return { markCount: m[1].length, name: m[2].trim() };
    }
    function getStorageKey(prefix, taskName, playerIndex, boxIndex) {
      return `${prefix}_check_${taskName}_${playerIndex}_${boxIndex}`;
    }
    function getNoteKey(taskName, playerIndex) {
      return `note_${taskName}_${playerIndex}`;
    }
    function getBigMemoKey(prefix, playerIndex) {
      return `${prefix}_memo_${playerIndex}`;
    }

    // ===== 시간 유틸 =====
    const MS = { min: 60000, hour: 3600000, half: 30*60000, twelve: 12*3600000 };

    function floorToHalfHour(d) {
      const x = new Date(d);
      x.setSeconds(0,0);
      x.setMinutes(x.getMinutes() < 30 ? 0 : 30);
      return x;
    }
    function nextHalfHour(d) {
      return new Date(floorToHalfHour(d).getTime() + MS.half);
    }

    function floorToNoonMidnight(d) {
      const x = new Date(d);
      x.setSeconds(0,0);
      x.setMinutes(0);
      x.setHours(x.getHours() < 12 ? 0 : 12);
      return x;
    }
    function nextNoonMidnight(d) {
      return new Date(floorToNoonMidnight(d).getTime() + MS.twelve);
    }

    function fmtTime(dt) {
      return `${String(dt.getHours()).padStart(2,'0')}:${String(dt.getMinutes()).padStart(2,'0')}`;
    }
    function fmtCountdown(ms) {
      const h = Math.floor(ms / MS.hour);
      const m = Math.floor((ms % MS.hour) / MS.min);
      const s = Math.floor((ms % MS.min) / 1000);
      if (h > 0) return `${h}시간 ${m}분 ${s}초 후 +1`;
      if (m > 0) return `${m}분 ${s}초 후 +1`;
      return `${s}초 후 +1`;
    }

    function renderTasks(taskList, tableId, prefix) {
      const table = document.getElementById(tableId);
      table.innerHTML = "";
      taskList.forEach(raw => {
        const task = parseTask(raw);
        if (!task) return;

        const row = document.createElement("tr");
        const nameCell = document.createElement("td");
        nameCell.textContent = task.name;
        nameCell.className = "task-name";
        row.appendChild(nameCell);

        for (let i = 0; i < playerNames.length; i++) {
          const cell = document.createElement("td");

          if (task.name === "동전" || task.name === "공물") {
            const input = document.createElement("input");
            input.type = "number";
            input.min = 0;
            input.max = task.name === "동전" ? 100 : 10;

            const timer = document.createElement("div");
            timer.className = "timer";
            const hint = document.createElement("div");
            hint.className = "hint";
            hint.textContent = task.name === "동전"
              ? "기준: 매시 정각·30분"
              : "기준: 매일 00:00·12:00";

            const key = `${prefix}_counter_${task.name}_${i}`;
            let data = JSON.parse(localStorage.getItem(key));
            if (!data) {
              const now = new Date();
              const lastAligned = task.name === "동전" ? floorToHalfHour(now) : floorToNoonMidnight(now);
              data = { value: 0, lastAligned: lastAligned.getTime() };
              localStorage.setItem(key, JSON.stringify(data));
            }

            function updateCounter() {
              const now = new Date();
              const step = task.name === "동전" ? MS.half : MS.twelve;
              const floorFn = task.name === "동전" ? floorToHalfHour : floorToNoonMidnight;
              const nextFn  = task.name === "동전" ? nextHalfHour : nextNoonMidnight;

              const lastAligned = new Date(data.lastAligned || now.getTime());
              const currentFloor = floorFn(now);
              let steps = Math.floor((currentFloor.getTime() - lastAligned.getTime()) / step);
              if (steps > 0) {
                data.value = Math.min((parseInt(data.value || 0) + steps), parseInt(input.max));
                data.lastAligned = lastAligned.getTime() + steps * step;
                localStorage.setItem(key, JSON.stringify(data));
              }

              input.value = data.value;
              const next = nextFn(now);
              const remaining = next.getTime() - now.getTime();
              timer.textContent = `${fmtCountdown(remaining)}`;
            }

            input.addEventListener("input", () => {
              const v = Math.max(0, Math.min(parseInt(input.value || 0), parseInt(input.max)));
              data.value = v;
              localStorage.setItem(key, JSON.stringify(data));
            });

            updateCounter();
            setInterval(updateCounter, 1000);

            const wrapper = document.createElement("div");
            wrapper.className = "counter-wrapper";
            wrapper.appendChild(input);
            wrapper.appendChild(timer);
            wrapper.appendChild(hint);
            cell.appendChild(wrapper);

          } else {
            const group = document.createElement("div");
            group.className = "checkbox-group";

            for (let j = 0; j < task.markCount; j++) {
              const checkbox = document.createElement("input");
              checkbox.type = "checkbox";
              const key = getStorageKey(prefix, task.name, i, j);
              checkbox.checked = localStorage.getItem(key) === "1";
              checkbox.addEventListener("change", () => {
                localStorage.setItem(key, checkbox.checked ? "1" : "0");
              });
              group.appendChild(checkbox);
            }

            if (prefix === "day" && task.name === "망령") {
              const note = document.createElement("input");
              note.className = "note-input";
              note.placeholder = "30-5";
              const noteKey = getNoteKey(task.name, i);
              note.value = localStorage.getItem(noteKey) || "";
              note.addEventListener("input", () => {
                localStorage.setItem(noteKey, note.value);
              });
              group.appendChild(note);
            }

            cell.appendChild(group);
          }
          row.appendChild(cell);
        }
        table.appendChild(row);
      });

      if (prefix === "weekly") appendBigMemoRow(tableId, prefix);
    }

    function appendBigMemoRow(tableId, prefix) {
      const table = document.getElementById(tableId);
      const row = document.createElement("tr");
      const nameCell = document.createElement("td");
      nameCell.textContent = "메모";
      nameCell.className = "task-name";
      row.appendChild(nameCell);

      for (let i = 0; i < playerNames.length; i++) {
        const cell = document.createElement("td");
        const textarea = document.createElement("textarea");
        textarea.className = "big-note";
        textarea.placeholder = "주간 메모를 입력하세요. (초기화되지 않음)";
        const key = getBigMemoKey(prefix, i);
        textarea.value = localStorage.getItem(key) || "";
        textarea.addEventListener("input", () => {
          localStorage.setItem(key, textarea.value);
        });
        cell.appendChild(textarea);
        row.appendChild(cell);
      }
      table.appendChild(row);
    }

    function updateName(index, newName) {
      playerNames[index] = newName;
      renderTasks(dayTasks, 'dayTaskTable', 'day');
      renderTasks(weeklyTasks, 'weeklyTaskTable', 'weekly');
    }

    function clearOldData(prefix, taskList) {
      const now = new Date();
      const last = localStorage.getItem(`${prefix}_last_reset`);
      const shouldReset = (prefix === 'day')
        ? (now.getHours() >= 6 && (!last || new Date(last).toDateString() !== now.toDateString()))
        : (now.getDay() === 1 && now.getHours() >= 6 && (!last || new Date(last).toDateString() !== now.toDateString()));
      if (shouldReset) {
        taskList.forEach(raw => {
          const task = parseTask(raw);
          if (!task) return;
          for (let i = 0; i < playerNames.length; i++) {
            for (let j = 0; j < task.markCount; j++) {
              localStorage.removeItem(getStorageKey(prefix, task.name, i, j));
            }
          }
        });
        localStorage.setItem(`${prefix}_last_reset`, now.toISOString());
      }
    }

    clearOldData('day', dayTasks);
    clearOldData('weekly', weeklyTasks);
    renderTasks(dayTasks, 'dayTaskTable', 'day');
    renderTasks(weeklyTasks, 'weeklyTaskTable', 'weekly');
  </script>
</body>
</html>
